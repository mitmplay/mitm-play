/* global location */
/* eslint-disable camelcase */
const _ws_namespace = require('./_ws_namespace')

let _timeout
let _csp = {}
module.exports = () => {
  const cspError = function (e) {
    const { hostname: host } = location
    const namespace = _ws_namespace()
    const path = location.pathname
      .replace(/^\//, '')
      .replace(/\//g, '-')
    const {
      blockedURI,
      disposition,
      documentURI,
      effectiveDirective,
      originalPolicy,
      timeStamp,
      type,
      violatedDirective
    } = e
    const typ = `[${disposition}] ${documentURI}`
    if (!_csp[typ]) {
      _csp[typ] = {}
    }
    if (!_csp[typ]._general_) {
      _csp[typ]._general_ = {
        policy: originalPolicy,
        namespace,
        host,
        path
      }
    }
    const _doc = _csp[typ]
    if (!_doc[violatedDirective]) {
      _doc[violatedDirective] = {}
    }

    const _err = _doc[violatedDirective]
    if (!_err[blockedURI]) {
      _err[blockedURI] = {}
    }
    const _match = originalPolicy.match(`${violatedDirective} [^;]+;`)
    const directive = _match ? _match[0] : effectiveDirective
    _err[blockedURI] = {
      directive,
      timeStamp,
      type
    }
    _timeout && clearTimeout(_timeout)
    _timeout = setTimeout(() => {
      console.log('>>> CSP:', _csp)
      // window.ws__send('csp_error', {
      //   namespace,
      //   host,
      //   path,
      //   _csp,
      // });
      _csp = {}
    }, 4000)
  }

  if (window.mitm.client.csp) {
    document.addEventListener('securitypolicyviolation', cspError)
  }
}
// disposition: "report"
// documentURI: "https://what/html/contain/csp"
// violatedDirective: "img-src"

// blockedURI: "https://what/url/getting/blocked"
// effectiveDirective: "img-src"
// originalPolicy: "script-src null; frame-src null; style-src null; style-src-elem null; img-src null;"
// timeStamp: 1933.8200000056531
// type: "securitypolicyviolation"
